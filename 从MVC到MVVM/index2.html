<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>书籍管理_Demo</title>
</head>
<body>
<div id="app">
    
</div>

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script>
// 在真正返回response 之前使用
fakeData()
// 上面是假的后台 

let model = {
    data: {
        name: '',
        number: 0,
        id: ''
    },
    fetch(id){
        return axios.get(`/books/${id}`).then(({response})=> {
            this.data = response.data
            return response
        })
    },
    updata(id, data){
        return axios.put(`/books/${id}`, data).then((response)=> {
            this.data = response.data
            return response
        })
    }
}

let view = {
    el: '#app',
    template: `
    <div>
        书名： 《__name__》
        数量： <span id="number">__number__</span>
    </div>
    <div>
        <button id="addOne">加1</button>
        <button id="minusOne">减1</button>
        <button id="reset">归零</button>
    </div>
    `,
    render(data) {
        let html = this.template('__name__', data.name)
            .replace('__number__', data.number)
        $(this.el).html(html)
    }
}

var controller = {
    init(options) {
        let {view, model} = options
        this.view = view
        this.model = model
        this.view.render(this.model.data)
        this.bindEvents
        model.fetch(1)
            .then( () => {
                this.view.render(this.model.data)
            })
    },
    addOne() {
        var oldNumber = $('#number').text() //string
        var newNumber = oldNumber - 0 + 1
        this.model.updata({number: newNumber}).then(({data}) => {
            // $('#number').text(newNumber)
            this.view.render(this.model.data)
        })
    },
    minusOne(){
        var oldNumber = $('#number').text() //string
        var newNumber = oldNumber - 0 - 1
        this.model.updata({number: newNumber}).then(() => {
            // $('#number').text(newNumber)
            this.view.render(this.model.data)
        })
    },
    reset() {
        this.model.updata({number: 0}).then(()=> {
            $('#number').text(0)
            this.view.render(this.model.data)
        })
    },
    bindEvents() {
        $('this.view.el').on('click', '#addOne', this.addOne.bind(this))
        $('this.view.el').on('click', '#minusOne', this.minusOne.bind(this))
        $('this.view.el').on('click', '#reset', this.reset.bind(this))
    }
}

controller.init({view: view, model: model})


// Mock
function fakeData() {
    let book = {
    name: 'JavaScript高级程序设计',
    number: 2,
    id: 1
}
    axios.interceptors.response.use(function (response) {
        let {config: {method, url, data}} = response

        if(url === './books/1' && method === 'get') {
            response.data = book
        } else if (url === './books/1' && method === 'put') {
            Object.assign(book, data)
            response.data = book
        }
        return response
    })
}

</script>
</body>
</html>